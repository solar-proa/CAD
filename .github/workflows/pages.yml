name: Build and Deploy GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Cache FreeCAD AppImage
        id: cache-freecad
        uses: actions/cache@v3
        with:
          path: |
            FreeCAD.AppImage
            squashfs-root
          key: freecad-1.0.0-appimage
      
      - name: Install FreeCAD AppImage
        if: steps.cache-freecad.outputs.cache-hit != 'true'
        run: |
          # Download FreeCAD 1.0.0 AppImage
          wget -O FreeCAD.AppImage https://github.com/FreeCAD/FreeCAD-Bundle/releases/download/1.0.0/FreeCAD_1.0.0-conda-Linux-x86_64-py311.AppImage
          chmod +x FreeCAD.AppImage
          
          # Extract AppImage
          ./FreeCAD.AppImage --appimage-extract
      
      - name: Setup FreeCAD environment
        run: |
          # Install xvfb for headless rendering and ImageMagick for cropping
          sudo apt-get update
          sudo apt-get install -y xvfb imagemagick
          
          # Create wrapper for running FreeCAD in console mode (for builds)
          cat > freecadcmd << 'WRAPPER_EOF'
          #!/bin/bash
          xvfb-run -a ./squashfs-root/usr/bin/freecad --console "$@"
          WRAPPER_EOF
          chmod +x freecadcmd
          
          # Create wrapper for running Python scripts with FreeCAD modules (for renders)
          cat > freecad-python << 'WRAPPER_EOF'
          #!/bin/bash
          export FREECAD_USER_HOME=/tmp/freecad
          export LD_LIBRARY_PATH=./squashfs-root/usr/lib:$LD_LIBRARY_PATH
          export PYTHONPATH=./squashfs-root/usr/lib:./squashfs-root/usr/Mod:$PYTHONPATH
          mkdir -p $FREECAD_USER_HOME
          xvfb-run -a ./squashfs-root/usr/bin/python "$@"
          WRAPPER_EOF
          chmod +x freecad-python
          
          # Add to PATH
          echo "$PWD" >> $GITHUB_PATH
      
      - name: Build all FreeCAD models
        run: |
          make design-all

      - name: Export renders from all models
        run: |
          make render-all
      
      - name: Generate downloads YAML files
        run: |
          python3 src/design/generate_downloads_yaml.py
      
      - name: Copy aggregate files to docs folder
        run: |
          mkdir -p docs/_data
          # Copy JSON files and rename with Jekyll-friendly names (dots to underscores)
          for file in artifacts/*.aggregate.json; do
            if [ -f "$file" ]; then
              basename=$(basename "$file" .aggregate.json)
              # Convert rp2.closehaul to rp2_closehaul for Jekyll
              newname=$(echo "$basename" | tr '.' '_')
              cp "$file" "docs/_data/${newname}.json"
              echo "Copied $file -> docs/_data/${newname}.json"
            fi
          done
      
      - name: Copy renders to docs folder
        run: |
          mkdir -p docs/renders
          cp artifacts/*.png docs/renders/ 2>/dev/null || echo "No renders to copy"
      
      - name: Copy FCStd models to downloads folder
        run: |
          mkdir -p docs/downloads
          cp artifacts/*.design.FCStd docs/downloads/ 2>/dev/null || echo "No FCStd files to copy"
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
          working-directory: ./docs
      
      - name: Install Jekyll dependencies
        run: |
          cd docs
          bundle install
      
      - name: Build Jekyll site manually
        run: |
          cd docs
          bundle exec jekyll build --destination ../_site
        env:
          JEKYLL_ENV: production
          PAGES_REPO_NWO: ${{ github.repository }}
          JEKYLL_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify Jekyll site build
        run: |
          echo "=== Jekyll site structure ==="
          ls -la _site/
          echo "=== Checking for data directory in source ==="
          ls -la docs/_data/ || echo "No _data directory"
          echo "=== Sample JSON file content ==="
          cat docs/_data/rp2_closehaul.json 2>/dev/null || echo "File not found"
          echo "=== Sample page content (should show data values, not liquid tags) ==="
          grep -A5 "Overall Length" _site/rp2.html || echo "Page not found"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
