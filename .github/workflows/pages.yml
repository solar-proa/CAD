name: Build and Deploy GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Cache FreeCAD AppImage
        id: cache-freecad
        uses: actions/cache@v3
        with:
          path: |
            FreeCAD.AppImage
            squashfs-root
          key: freecad-1.0.0-appimage
      
      - name: Install FreeCAD AppImage
        if: steps.cache-freecad.outputs.cache-hit != 'true'
        run: |
          # Download FreeCAD 1.0.0 AppImage
          wget -O FreeCAD.AppImage https://github.com/FreeCAD/FreeCAD-Bundle/releases/download/1.0.0/FreeCAD_1.0.0-conda-Linux-x86_64-py311.AppImage
          chmod +x FreeCAD.AppImage
          
          # Extract AppImage
          ./FreeCAD.AppImage --appimage-extract
      
      - name: Setup FreeCAD environment
        run: |
          # Install xvfb for headless rendering, ImageMagick for cropping, and graphviz for dependency graph
          sudo apt-get update
          sudo apt-get install -y xvfb imagemagick graphviz
          
          # Create wrapper for running FreeCAD in console mode (for builds)
          cat > freecadcmd << 'WRAPPER_EOF'
          #!/bin/bash
          xvfb-run -a ./squashfs-root/usr/bin/freecad --console "$@"
          WRAPPER_EOF
          chmod +x freecadcmd
          
          # Create wrapper for running Python scripts with FreeCAD modules (for renders)
          cat > freecad-python << 'WRAPPER_EOF'
          #!/bin/bash
          export FREECAD_USER_HOME=/tmp/freecad
          export LD_LIBRARY_PATH=./squashfs-root/usr/lib:$LD_LIBRARY_PATH
          export PYTHONPATH=./squashfs-root/usr/lib:./squashfs-root/usr/Mod:$PYTHONPATH
          mkdir -p $FREECAD_USER_HOME
          xvfb-run -a ./squashfs-root/usr/bin/python "$@"
          WRAPPER_EOF
          chmod +x freecad-python
          
          # Add to PATH
          echo "$PWD" >> $GITHUB_PATH
      
      - name: Install Python dependencies for validation
        run: |
          pip install matplotlib numpy

      - name: Cache ngspice shared library
        id: cache-ngspice
        uses: actions/cache@v3
        with:
          path: /usr/local/lib/libngspice*
          key: ngspice-34-shared

      - name: Build and install ngspice shared library
        if: steps.cache-ngspice.outputs.cache-hit != 'true'
        run: |
          sudo apt-get install -y libtool autoconf automake libreadline-dev
          git clone https://git.code.sf.net/p/ngspice/ngspice /tmp/ngspice-code
          cd /tmp/ngspice-code
          git checkout ngspice-34
          ./autogen.sh
          ./configure --prefix=/usr/local --with-ngshared --enable-xspice --disable-debug
          make -j$(nproc)
          sudo make install
          rm -rf /tmp/ngspice-code

      - name: Configure ngspice library path
        run: |
          sudo ln -sf /usr/local/lib/libngspice.so.0 /usr/local/lib/libngspice.so
          echo "/usr/local/lib" | sudo tee /etc/ld.so.conf.d/ngspice.conf
          sudo ldconfig

      - name: Install PySpice
        run: |
          pip install PySpice

      - name: Install TeX Live and SVG tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y texlive texlive-fonts-extra latexmk librsvg2-bin

      - name: Build all required FreeCAD models and run all stages
        run: |
          make required-all

      - name: Generate downloads YAML files
        run: |
          python3 docs/generate_downloads_yaml.py

      - name: Generate configurations YAML file
        run: |
          python3 docs/generate_configurations_yaml.py

      - name: Generate dependency graph
        run: |
          python3 docs/generate_dependency_graph.py

      - name: Generate diagrams
        run: |
          python3 -m src.validate_structure.diagrams

      - name: Copy constant files to docs/_data
        run: |
          mkdir -p docs/_data
          cp constant/view.json docs/_data/

      - name: Copy artifact data files to docs folder
        run: |
          # Copy JSON files and rename with Jekyll-friendly names (dots to underscores)
          count=0
          for file in artifact/*.json; do
            if [ -f "$file" ]; then
              basename=$(basename "$file" .json)
              # Convert rp2.closehaul to rp2_closehaul for Jekyll
              newname=$(echo "$basename" | tr '.' '_')
              cp "$file" "docs/_data/${newname}.json"
              echo "Copied $file -> docs/_data/${newname}.json"
              count=$((count + 1))
            fi
          done
          echo "Total data files copied: $count"
          if [ $count -eq 0 ]; then
            echo "ERROR: No validate files were copied!"
            exit 1
          fi
      
      - name: Copy renders to docs/renders folder
        run: |
          mkdir -p docs/renders
          if ls artifact/*.png 1> /dev/null 2>&1; then
            cp artifact/*.png docs/renders/
            echo "Copied $(ls artifact/*.png | wc -l) render files"
          else
            echo "WARNING: No render PNG files found in artifact/"
          fi
      
      - name: Copy PDFs to docs/lines folder
        run: |
          mkdir -p docs/lines
          if ls artifact/*.pdf 1> /dev/null 2>&1; then
            cp artifact/*.pdf docs/lines/
            echo "Copied $(ls artifact/*.pdf | wc -l) PDF files"
          else
            echo "WARNING: No PDF files found in artifact/"
          fi
      
      - name: Copy SVGs to docs/lines folder
        run: |
          mkdir -p docs/lines
          if ls artifact/*.svg 1> /dev/null 2>&1; then
            cp artifact/*.svg docs/lines/
            echo "Copied $(ls artifact/*.svg | wc -l) SVG files"
          else
            echo "WARNING: No SVG files found in artifact/"
          fi
      
      - name: Copy FCStd models to docs/downloads folder
        run: |
          mkdir -p docs/downloads
          if ls artifact/*.FCStd 1> /dev/null 2>&1; then
            cp artifact/*.FCStd docs/downloads/
            echo "Copied $(ls artifact/*.FCStd | wc -l) FCStd files"
          else
            echo "WARNING: No FCStd files found in artifact/"
          fi

      - name: Copy STEP models to docs/downloads folder
        run: |
          if ls artifact/*.step.step 1> /dev/null 2>&1; then
            cp artifact/*.step.step docs/downloads/
            echo "Copied $(ls artifact/*.step.step | wc -l) STEP files"
          else
            echo "WARNING: No STEP files found in artifact/"
          fi

      - name: Verify files before Jekyll build
        run: |
          echo "=== Files in docs/renders/ ==="
          ls -lh docs/renders/ || echo "No renders directory"
          echo ""
          echo "=== Files in docs/downloads/ ==="
          ls -lh docs/downloads/ || echo "No downloads directory"
          echo ""
          echo "=== Files in docs/_data/ ==="
          ls -lh docs/_data/ || echo "No _data directory"
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
          working-directory: ./docs
      
      - name: Install Jekyll dependencies
        run: |
          cd docs
          bundle install
      
      - name: Build Jekyll site manually
        run: |
          cd docs
          bundle exec jekyll build
        env:
          JEKYLL_ENV: production
          PAGES_REPO_NWO: ${{ github.repository }}
          JEKYLL_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify Jekyll site build
        run: |
          echo "=== Jekyll _site structure ==="
          ls -la docs/_site/
          echo ""
          echo "=== Check for renders in _site ==="
          ls -lh docs/_site/renders/ || echo "No renders in _site"
          echo ""
          echo "=== Check for downloads in _site ==="
          ls -lh docs/_site/downloads/ || echo "No downloads in _site"
          echo ""
          echo "=== Checking source directories ==="
          ls -la docs/_data/ || echo "No _data directory"
          ls -la docs/renders/ || echo "No renders directory"
          ls -la docs/downloads/ || echo "No downloads directory"
          echo ""
          echo "=== Sample JSON file content ==="
          cat docs/_data/rp2_closehaul.json 2>/dev/null || echo "File not found"
          echo ""
          echo "=== Sample page content (should show data values, not liquid tags) ==="
          grep -A5 "Overall Length" docs/_site/rp2.html || echo "Page not found"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs/_site'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
